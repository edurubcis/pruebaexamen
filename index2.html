<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Examen Seguro</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f5f5f5;
    }
    header {
      background: #222;
      color: #fff;
      padding: 10px 20px;
    }
    main {
      padding: 20px;
    }
    .hidden {
      display: none;
    }
    .center {
      text-align: center;
    }
    #wrapper {
      max-width: 1000px;
      margin: 0 auto;
    }
    #message {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    #message.info {
      background: #e5f0ff;
      color: #003366;
    }
    #message.error {
      background: #ffe5e5;
      color: #b30000;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      margin-top: 15px;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-danger {
      background: #cc0000;
      color: white;
    }
    .btn-danger:hover {
      background: #990000;
    }
    section.step {
      background: #ffffff;
      border-radius: 6px;
      padding: 20px;
      box-shadow: 0 0 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    iframe {
      width: 100%;
      height: 70vh;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
    }
  </style>
</head>
<body>

  <header>
    <h1>Examen Seguro</h1>
  </header>

  <main>
    <div id="wrapper">

      <div id="message" class="info">
        <strong>Bienvenido al examen.</strong>
        <br>
        Sigue las instrucciones paso a paso. Las infracciones solo aplican en el tercer paso (examen).
      </div>

      <!-- PASO 1: Instrucciones generales -->
      <section id="step1" class="step">
        <h2>Paso 1: Instrucciones generales</h2>
        <p>
          En este examen:
        </p>
        <ul>
          <li>No debes cambiar de pesta√±a, ventana ni minimizar mientras respondes el examen.</li>
          <li>Durante el examen, el sistema detectar√° si sales de la ventana m√°s de un segundo.</li>
          <li>La primera vez que ocurra, el profesor puede decidir rehabilitarte con un c√≥digo.</li>
          <li>Si ocurre de nuevo, el examen se cancelar√° autom√°ticamente.</li>
        </ul>
        <p>
          Da clic en el siguiente bot√≥n para ir al formulario de registro. Todav√≠a no se aplica ninguna penalizaci√≥n.
        </p>
        <div class="center">
          <button id="btn-step1-next" class="btn-primary">Siguiente: Registro</button>
        </div>
      </section>

      <!-- PASO 2: Formulario de registro embebido -->
      <section id="step2" class="step hidden">
        <h2>Paso 2: Registro previo</h2>
        <p>
          Completa el siguiente formulario de registro (matr√≠cula, nombre, grupo y aceptaci√≥n del c√≥digo de √©tica).
          Una vez que des clic en <strong>Enviar</strong> en el formulario, regresa aqu√≠ y pulsa <strong>Siguiente</strong>.
        </p>
        <iframe
          id="registro-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLSdNY8t6a8wgaxOrCKfAp1LGvFAEdnuJCr5WPW4lOycLHRgXGw/viewform?embedded=true"
          frameborder="0"
          marginheight="0"
          marginwidth="0"
        >
          Cargando formulario de registro‚Ä¶
        </iframe>
        <div class="center">
          <button id="btn-step2-next" class="btn-primary">
            Siguiente: Iniciar examen
          </button>
        </div>
      </section>

      <!-- PASO 3: Formulario de examen embebido (con infracciones activas) -->
      <section id="step3" class="step hidden">
        <h2>Paso 3: Examen</h2>
        <p id="exam-status" class="center">
          <strong>Examen en curso.</strong> No salgas de esta pesta√±a, ni cambies de ventana, ni minimices.
        </p>
        <p>
          Responde el formulario de examen que aparece abajo. Al terminar de contestar en el formulario de Google Forms
          (bot√≥n Enviar dentro del formulario), regresa aqu√≠ y da clic en <strong>Finalizar examen</strong>.
        </p>
        <iframe
          id="exam-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLSeiIBCLX_ZMesEVRWFLM-RzCTWkScELdgI1m2ZURg91HGzpSQ/viewform?embedded=true"
          frameborder="0"
          marginheight="0"
          marginwidth="0"
        >
          Cargando formulario de examen‚Ä¶
        </iframe>
        <div class="center">
          <button id="btn-finish-exam" class="btn-danger">
            Finalizar examen
          </button>
        </div>
      </section>

      <!-- PASO 4: Mensaje final de examen enviado -->
      <section id="step4-success" class="step hidden">
        <h2>Examen enviado</h2>
        <p>
          Tu examen ha sido finalizado satisfactoriamente (desde esta plataforma).
          Aseg√∫rate de que el formulario de Google Forms muestre tambi√©n su confirmaci√≥n de env√≠o.
        </p>
        <p>
          Si tienes cualquier duda, levanta la mano y com√©ntalo con tu profesor.
        </p>
      </section>

    </div>
  </main>

  <script>
    // üëá CAMBIA ESTE C√ìDIGO POR EL QUE QUIERAS USAR COMO PROFESOR
    const TEACHER_CODE = "1805";

    // Tiempo m√≠nimo fuera antes de contar como infracci√≥n (ms)
    const AWAY_THRESHOLD_MS = 1000; // 1 segundo

    // Estado general
    let currentStep = 1;
    let examIsActive = false;
    let examCanceled = false;
    let teacherCodeUsed = false;   // true despu√©s de la primera infracci√≥n perdonada
    let monitoringActive = false;  // empieza a vigilar solo en el paso 3
    let penaltyEnabled = false;    // flag extra para evitar penalizaci√≥n al finalizar
    let awaySince = null;          // momento en que sali√≥ de pesta√±a/ventana
    let suppressionUntil = 0;   // ignorar infracciones hasta este momento (ms)

    const messageDiv = document.getElementById('message');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4-success');
    const examFrame = document.getElementById('exam-frame');
    const examStatusP = document.getElementById('exam-status');

    const btnStep1Next = document.getElementById('btn-step1-next');
    const btnStep2Next = document.getElementById('btn-step2-next');
    const btnFinishExam = document.getElementById('btn-finish-exam');

    function showMessage(html, type = 'info') {
      messageDiv.innerHTML = html;
      messageDiv.className = '';
      messageDiv.classList.add(type);
      messageDiv.id = 'message';
    }

    // Cambiar de paso
    function goToStep(stepNumber) {
      currentStep = stepNumber;

      // Ocultar todos
      step1.classList.add('hidden');
      step2.classList.add('hidden');
      step3.classList.add('hidden');
      step4.classList.add('hidden');

      if (stepNumber === 1) {
        step1.classList.remove('hidden');
        stopExamMonitoring();
        showMessage(
          '<strong>Bienvenido al examen.</strong><br>' +
          'Sigue las instrucciones del Paso 1. A√∫n no se aplican infracciones.',
          'info'
        );
      } else if (stepNumber === 2) {
        step2.classList.remove('hidden');
        stopExamMonitoring();
        showMessage(
          '<strong>Paso 2:</strong> Completa el formulario de registro. ' +
          'Despu√©s de enviarlo, da clic en "Siguiente: Iniciar examen". A√∫n no se aplican infracciones.',
          'info'
        );
      } else if (stepNumber === 3) {
        step3.classList.remove('hidden');
        startExam();
      } else if (stepNumber === 4) {
        step4.classList.remove('hidden');
        stopExamMonitoring();
        showMessage(
          '<strong>Examen finalizado.</strong> Si el formulario de Google Forms mostr√≥ su confirmaci√≥n, ' +
          'tu examen ha quedado registrado.',
          'info'
        );
      }
    }

    function startExam() {
      examIsActive = true;
      examCanceled = false;
      teacherCodeUsed = false;
      monitoringActive = false;
      penaltyEnabled = false; // lo activamos despu√©s de un breve delay
      awaySince = null;

      examFrame.classList.remove('hidden');
      examStatusP.classList.remove('hidden');

      showMessage(
        '<strong>Paso 3:</strong> Examen iniciado. Permanece en esta pesta√±a/ventana. ' +
        'La primera infracci√≥n pedir√° un c√≥digo del profesor; la segunda cancelar√° el examen.',
        'info'
      );

      // Activar vigilancia despu√©s de 0.5 s para evitar falsos positivos al entrar
      setTimeout(() => {
        monitoringActive = true;
        penaltyEnabled = true;
      }, 500);
    }

    function stopExamMonitoring() {
      examIsActive = false;
      examCanceled = false;
      monitoringActive = false;
      penaltyEnabled = false;
      awaySince = null;
    }

    function cancelExam(reason) {
      if (!examIsActive || examCanceled) return;
      examCanceled = true;
      examIsActive = false;
      monitoringActive = false;
      penaltyEnabled = false;
      awaySince = null;

      examFrame.classList.add('hidden');
      examStatusP.classList.add('hidden');

      showMessage('<strong>Examen cancelado.</strong> ' + reason, 'error');
      alert('Tu examen ha sido cancelado.\n\n' + reason);
    }

    function handleInfraction(reason) {
  // Si el examen ya no est√° activo o las penalizaciones est√°n apagadas, no hacemos nada
  if (!examIsActive || examCanceled || !penaltyEnabled) return;

  // ‚ö†Ô∏è Pausamos la vigilancia mientras se maneja esta infracci√≥n
  monitoringActive = false;
  penaltyEnabled = false;
  awaySince = null;

  // Si ya se us√≥ el c√≥digo una vez, cualquier nueva infracci√≥n cancela
  if (teacherCodeUsed) {
    cancelExam(reason + ' (segunda infracci√≥n).');
    return;
  }

  // Primera infracci√≥n: permitir usar c√≥digo
  const code = prompt(
    'Se detect√≥ una posible infracci√≥n:\n\n' + reason +
    '\n\nPide a tu profesor el c√≥digo para continuar. ' +
    'Si no lo ingresas correctamente, el examen ser√° cancelado.'
  );

  if (code === TEACHER_CODE) {
    // C√≥digo correcto ‚Üí seguimos en el examen (Paso 3)
    teacherCodeUsed = true;

    // Reafirmamos el estado del examen
    examIsActive = true;
    examCanceled = false;
    awaySince = null;
    

    // Nos aseguramos visualmente de seguir en el Paso 3
    currentStep = 3;
    step1.classList.add('hidden');
    step2.classList.add('hidden');
    step3.classList.remove('hidden');
    step4.classList.add('hidden');
    examFrame.classList.remove('hidden');
    examStatusP.classList.remove('hidden');

    alert('C√≥digo correcto. Puedes continuar, pero cualquier nueva infracci√≥n cancelar√° el examen.');
    showMessage(
      '<strong>Advertencia:</strong> Ya se detect√≥ una infracci√≥n. ' +
      'Si vuelves a salir de la pesta√±a/ventana o minimizar, el examen ser√° cancelado.',
      'error'
    );
    // Ignorar posibles eventos de foco/visibilidad inmediatamente despu√©s de la rehabilitaci√≥n
    suppressionUntil = Date.now() + 2000; // 2 segundos de ‚Äúcomod√≠n‚Äù

    // üîÅ Re-activamos la vigilancia con un peque√±o delay
    setTimeout(() => {
      if (!examCanceled && examIsActive) {
        monitoringActive = true;
        penaltyEnabled = true;
        awaySince = null;
      }
    }, 500);
  } else {
    // C√≥digo incorrecto o cancelado
    cancelExam(reason + ' (c√≥digo incorrecto o no ingresado).');
  }
}


    // Marca el momento en que se fue de pesta√±a/ventana (solo en paso 3)
    function markAway() {
      if (!examIsActive || !monitoringActive || !penaltyEnabled) return;
      if (awaySince === null) {
        awaySince = Date.now();
      }
    }

    // Calcula cu√°nto tiempo estuvo fuera y, si pasa el umbral, cuenta infracci√≥n
    function markBack(source) {
  if (!examIsActive || !monitoringActive || !penaltyEnabled) {
    awaySince = null;
    return;
  }

  // Ignorar eventos ‚Äúfantasma‚Äù justo despu√©s de una rehabilitaci√≥n
  if (Date.now() < suppressionUntil) {
    awaySince = null;
    return;
  }

  if (awaySince === null) return;

  const elapsed = Date.now() - awaySince;
  awaySince = null;

  if (elapsed >= AWAY_THRESHOLD_MS) {
    const seconds = Math.round(elapsed / 1000);
    handleInfraction(
      'La ' + source + ' del examen estuvo fuera de foco durante aproximadamente ' +
      seconds + ' segundos.'
    );
  }
}

    // üîê EXTRA: cualquier interacci√≥n dentro de la p√°gina "resetea" un posible awaySince viejo
    ['click', 'keydown', 'scroll', 'mousemove'].forEach(ev => {
      document.addEventListener(ev, () => {
        if (examIsActive && monitoringActive && penaltyEnabled) {
          // Si el alumno est√° interactuando dentro del examen,
          // asumimos que est√° presente y borramos cualquier marca vieja
          awaySince = null;
        }
      });
    });

    // 1) Cambio de visibilidad (pesta√±as)
    document.addEventListener('visibilitychange', () => {
      if (currentStep !== 3) return;
      if (document.hidden) {
        markAway();
      } else {
        markBack('pesta√±a');
      }
    });

    // 2) Cambio de foco de ventana (Alt+Tab, otra ventana, carpetas, etc.)
    window.addEventListener('blur', () => {
      if (currentStep !== 3) return;
      markAway();
    });

    window.addEventListener('focus', () => {
      if (currentStep !== 3) return;
      markBack('ventana');
    });

    // Aviso si intenta cerrar o recargar mientras el examen est√° activo
    window.addEventListener('beforeunload', (event) => {
      if (examIsActive && !examCanceled) {
        event.preventDefault();
        event.returnValue = '';
      }
    });

    // Botones de pasos
    btnStep1Next.addEventListener('click', () => {
      goToStep(2);
    });

    btnStep2Next.addEventListener('click', () => {
      // Aqu√≠ confiamos en que el alumno ya envi√≥ el Forms de registro
      goToStep(3);
    });

    btnFinishExam.addEventListener('click', () => {
      // Apagamos completamente el sistema de penalizaciones ANTES de cambiar de pantalla
      examIsActive = false;
      monitoringActive = false;
      penaltyEnabled = false;
      awaySince = null;
      goToStep(4);
    });

    // Iniciar en el Paso 1
    goToStep(1);
  </script>
</body>
</html>
