<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Examen Seguro</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f5f5f5;
    }
    header {
      background: #222;
      color: #fff;
      padding: 10px 20px;
    }
    main {
      padding: 20px;
    }
    .hidden {
      display: none;
    }
    .center {
      text-align: center;
    }
    #wrapper {
      max-width: 1000px;
      margin: 0 auto;
    }
    #message {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    #message.info {
      background: #e5f0ff;
      color: #003366;
    }
    #message.error {
      background: #ffe5e5;
      color: #b30000;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      margin-top: 15px;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-danger {
      background: #cc0000;
      color: white;
    }
    .btn-danger:hover {
      background: #990000;
    }
    section.step {
      background: #ffffff;
      border-radius: 6px;
      padding: 20px;
      box-shadow: 0 0 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    iframe {
      width: 100%;
      height: 70vh;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
    }

    /* Overlay de confirmaci√≥n */
    #finish-confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    /* MUY IMPORTANTE: al tener .hidden, s√≠ se oculta */
    #finish-confirm-overlay.hidden {
      display: none;
    }
    #finish-confirm-box {
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

  <header>
    <h1>Examen Seguro</h1>
  </header>

  <main>
    <div id="wrapper">

      <div id="message" class="info">
        <strong>Bienvenido al examen.</strong>
        <br>
        Sigue las instrucciones paso a paso.
      </div>

      <!-- PASO 1: Instrucciones generales -->
      <section id="step1" class="step">
        <h2>Paso 1: Instrucciones generales</h2>
        <p>
          En este examen:
        </p>
        <ul>
          <li>No debes cambiar de pesta√±a, ventana ni minimizar mientras respondes el examen.</li>
          <li>Durante el examen, el sistema detectar√° si sales de la ventana m√°s de un segundo.</li>
          <li>La primera vez que ocurra, el profesor puede decidir rehabilitar el examen con un c√≥digo.</li>
          <li>Si ocurre de nuevo, el examen se cancelar√° autom√°ticamente.</li>
        </ul>
        <p>
          Da clic en el siguiente bot√≥n para ir al formulario de registro.
        </p>
        <div class="center">
          <button id="btn-step1-next" class="btn-primary">Siguiente: Registro</button>
        </div>
      </section>

      <!-- PASO 2: Formulario de registro embebido -->
      <section id="step2" class="step hidden">
        <h2>Paso 2: Registro previo</h2>
        <p>
          Completa el siguiente formulario de registro.
          Una vez que des clic en <strong>Enviar</strong> en el formulario, pulsa al final de la p√°gina el bot√≥n <strong>Siguiente</strong>.
        </p>
        <iframe
          id="registro-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLSdNY8t6a8wgaxOrCKfAp1LGvFAEdnuJCr5WPW4lOycLHRgXGw/viewform?embedded=true"
          frameborder="0"
          marginheight="0"
          marginwidth="0"
        >
          Cargando formulario de registro‚Ä¶
        </iframe>
        <div class="center">
          <button id="btn-step2-next" class="btn-primary">
            Siguiente: Iniciar examen
          </button>
        </div>
      </section>

      <!-- PASO 3: Formulario de examen embebido (con infracciones activas) -->
      <section id="step3" class="step hidden">
        <h2>Paso 3: Examen</h2>
        <p id="exam-status" class="center">
          <strong>Examen en curso.</strong> No salgas de esta pesta√±a, ni cambies de ventana, ni minimices.
        </p>
        <p>
          Responde el formulario de examen que aparece abajo. Al terminar de contestar en el formulario de Google Forms
          (bot√≥n Enviar dentro del formulario), finaliza tu examen dando clic en el bot√≥n rojo que dice <strong>Finalizar examen</strong>.
        </p>
        <iframe
          id="exam-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLSeiIBCLX_ZMesEVRWFLM-RzCTWkScELdgI1m2ZURg91HGzpSQ/viewform?embedded=true"
          frameborder="0"
          marginheight="0"
          marginwidth="0"
        >
          Cargando formulario de examen‚Ä¶
        </iframe>
        <div class="center">
          <button id="btn-finish-exam" class="btn-danger">
            Finalizar examen
          </button>
        </div>
      </section>

      <!-- PASO 4: Mensaje final de examen enviado -->
      <section id="step4-success" class="step hidden">
        <h2>Examen enviado</h2>
        <p>
          Tu examen ha sido finalizado satisfactoriamente.
        </p>
        <p>
          Si tienes cualquier duda, levanta la mano y com√©ntalo con tu profesor.
        </p>
      </section>

      <!-- PASO 5: Examen cancelado por infracciones -->
      <section id="step5-cancel" class="step hidden">
        <h2>Examen cancelado</h2>
        <p>
          Tu examen ha sido cancelado por cometer dos infracciones en el sistema de monitoreo.
        </p>
        <p>
          Permanece en tu lugar y llama a tu maestro para recibir indicaciones.
        </p>
      </section>

      <!-- OVERLAY DE CONFIRMACI√ìN AL FINALIZAR -->
      <div id="finish-confirm-overlay" class="hidden">
        <div id="finish-confirm-box">
          <p><strong>¬øEst√°s seguro que ya enviaste el formulario de Google Forms?</strong></p>
          <p>
            Verifica que el formulario de examen te haya mostrado el mensaje de
            <em>"Tus respuestas se han registrado"</em> antes de continuar.
          </p>
          <button id="btn-confirm-yes" class="btn-danger">
            S√≠, ya lo envi√©
          </button>
          <button id="btn-confirm-no" class="btn-primary">
            No, regresar al examen
          </button>
        </div>
      </div>

    </div>
  </main>

  <script>
    // üëá CAMBIA ESTE C√ìDIGO POR EL QUE QUIERAS USAR COMO PROFESOR
    const TEACHER_CODE = "1111";

    // Tiempo m√≠nimo fuera antes de contar como infracci√≥n (ms)
    const AWAY_THRESHOLD_MS = 1000; // 1 segundo

    // Estado general
    let currentStep = 1;
    let examIsActive = false;
    let examCanceled = false;
    let teacherCodeUsed = false;   // true despu√©s de la primera infracci√≥n perdonada
    let monitoringActive = false;  // empieza a vigilar solo en el paso 3
    let penaltyEnabled = false;    // flag extra para evitar penalizaci√≥n al finalizar
    let awaySince = null;          // momento en que sali√≥ de pesta√±a/ventana
    let suppressionUntil = 0;      // ignorar infracciones hasta este momento (ms)

    const messageDiv = document.getElementById('message');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4-success');
    const step5 = document.getElementById('step5-cancel');
    const examFrame = document.getElementById('exam-frame');
    const examStatusP = document.getElementById('exam-status');

    const btnStep1Next = document.getElementById('btn-step1-next');
    const btnStep2Next = document.getElementById('btn-step2-next');
    const btnFinishExam = document.getElementById('btn-finish-exam');

    const finishOverlay = document.getElementById('finish-confirm-overlay');
    const btnConfirmYes = document.getElementById('btn-confirm-yes');
    const btnConfirmNo = document.getElementById('btn-confirm-no');

    function showMessage(html, type = 'info') {
      messageDiv.innerHTML = html;
      messageDiv.className = '';
      messageDiv.classList.add(type);
      messageDiv.id = 'message';
    }

    // Cambiar de paso
    function goToStep(stepNumber) {
      currentStep = stepNumber;

      // Ocultar todos
      step1.classList.add('hidden');
      step2.classList.add('hidden');
      step3.classList.add('hidden');
      step4.classList.add('hidden');
      step5.classList.add('hidden');

      if (stepNumber === 1) {
        step1.classList.remove('hidden');
        stopExamMonitoring();
        showMessage(
          '<strong>Bienvenido al examen.</strong><br>' +
          'Sigue las instrucciones del Paso 1.',
          'info'
        );
      } else if (stepNumber === 2) {
        step2.classList.remove('hidden');
        stopExamMonitoring();
        showMessage(
          '<strong>Paso 2:</strong> Completa el formulario de registro. ' +
          'Despu√©s de enviarlo, da clic en "Siguiente: Iniciar examen".',
          'info'
        );
      } else if (stepNumber === 3) {
        step3.classList.remove('hidden');
        startExam();
      } else if (stepNumber === 4) {
        step4.classList.remove('hidden');
        stopExamMonitoring();
        showMessage(
          '<strong>Examen finalizado.</strong> Si el formulario de Google Forms mostr√≥ su confirmaci√≥n, ' +
          'tu examen ha quedado registrado.',
          'info'
        );
      } else if (stepNumber === 5) {
        step5.classList.remove('hidden');
        stopExamMonitoring();
        showMessage(
          '<strong>Examen cancelado.</strong> Has cometido dos infracciones. ' +
          'Permanece en tu lugar y llama a tu maestro.',
          'error'
        );
      }
    }

    function startExam() {
      examIsActive = true;
      examCanceled = false;
      teacherCodeUsed = false;
      monitoringActive = false;
      penaltyEnabled = false; // lo activamos despu√©s de un breve delay
      awaySince = null;
      suppressionUntil = 0;

      examFrame.classList.remove('hidden');
      examStatusP.classList.remove('hidden');

      showMessage(
        '<strong>Paso 3:</strong> Examen iniciado. Permanece en esta pesta√±a/ventana. ' +
        'La primera infracci√≥n pedir√° un c√≥digo del profesor; la segunda cancelar√° el examen <strong>autom√°ticamente</strong>.',
        'info'
      );

      // Activar vigilancia despu√©s de 0.5 s para evitar falsos positivos al entrar
      setTimeout(() => {
        monitoringActive = true;
        penaltyEnabled = true;
      }, 500);
    }

    function stopExamMonitoring() {
      examIsActive = false;
      examCanceled = false;
      monitoringActive = false;
      penaltyEnabled = false;
      awaySince = null;
      suppressionUntil = 0;
    }

    function cancelExam(reason) {
      if (examCanceled) return;
      examCanceled = true;
      examIsActive = false;
      monitoringActive = false;
      penaltyEnabled = false;
      awaySince = null;
      suppressionUntil = 0;

      // Ocultamos el examen y cualquier overlay
      examFrame.classList.add('hidden');
      examStatusP.classList.add('hidden');
      finishOverlay.classList.add('hidden');

      // Vamos al paso 5 (examen cancelado)
      goToStep(5);

      alert('Tu examen ha sido cancelado.\n\n' + reason);
    }

    function handleInfraction(reason) {
      // Si el examen ya no est√° activo o las penalizaciones est√°n apagadas, no hacemos nada
      if (!examIsActive || examCanceled || !penaltyEnabled) return;

      // Pausamos la vigilancia mientras se maneja esta infracci√≥n
      monitoringActive = false;
      penaltyEnabled = false;
      awaySince = null;

      // Si ya se us√≥ el c√≥digo una vez, cualquier nueva infracci√≥n cancela
      if (teacherCodeUsed) {
        cancelExam(reason + ' (segunda infracci√≥n).');
        return;
      }

      // Primera infracci√≥n: permitir usar c√≥digo
      const code = prompt(
        'Se detect√≥ una posible infracci√≥n:\n\n' + reason +
        '\n\nPide a tu profesor el c√≥digo para continuar. ' +
        'Si no lo ingresas correctamente, el examen ser√° cancelado.'
      );

      if (code === TEACHER_CODE) {
        // C√≥digo correcto ‚Üí seguimos en el examen (Paso 3)
        teacherCodeUsed = true;

        // Reafirmamos el estado del examen
        examIsActive = true;
        examCanceled = false;
        awaySince = null;

        // Nos aseguramos visualmente de seguir en el Paso 3
        currentStep = 3;
        step1.classList.add('hidden');
        step2.classList.add('hidden');
        step3.classList.remove('hidden');
        step4.classList.add('hidden');
        step5.classList.add('hidden');
        examFrame.classList.remove('hidden');
        examStatusP.classList.remove('hidden');

        alert('C√≥digo correcto. Puedes continuar, pero cualquier nueva infracci√≥n cancelar√° el examen.');
        showMessage(
          '<strong>Advertencia:</strong> Ya se detect√≥ una infracci√≥n. ' +
          'Si vuelves a salir de la pesta√±a/ventana o minimizar, el examen ser√° cancelado.',
          'error'
        );

        // Ignorar posibles eventos de foco/visibilidad inmediatamente despu√©s de la rehabilitaci√≥n
        suppressionUntil = Date.now() + 2000; // 2 segundos de colch√≥n

        // Re-activamos la vigilancia con un peque√±o delay
        setTimeout(() => {
          if (!examCanceled && examIsActive) {
            monitoringActive = true;
            penaltyEnabled = true;
            awaySince = null;
          }
        }, 500);
      } else {
        // C√≥digo incorrecto o cancelado
        cancelExam(reason + ' (c√≥digo incorrecto o no ingresado).');
      }
    }

    // Marca el momento en que se fue de pesta√±a/ventana (solo en paso 3)
    function markAway() {
      if (!examIsActive || !monitoringActive || !penaltyEnabled) return;
      if (awaySince === null) {
        awaySince = Date.now();
      }
    }

    // Calcula cu√°nto tiempo estuvo fuera y, si pasa el umbral, cuenta infracci√≥n
    function markBack(source) {
      if (!examIsActive || !monitoringActive || !penaltyEnabled) {
        awaySince = null;
        return;
      }

      // Ignorar eventos ‚Äúfantasma‚Äù justo despu√©s de una rehabilitaci√≥n
      if (Date.now() < suppressionUntil) {
        awaySince = null;
        return;
      }

      if (awaySince === null) return;

      const elapsed = Date.now() - awaySince;
      awaySince = null;

      if (elapsed >= AWAY_THRESHOLD_MS) {
        const seconds = Math.round(elapsed / 1000);
        handleInfraction(
          'La ' + source + ' del examen estuvo fuera de foco durante aproximadamente ' +
          seconds + ' segundos.'
        );
      }
    }

    // EXTRA: cualquier interacci√≥n dentro de la p√°gina "resetea" un posible awaySince viejo
    ['click', 'keydown', 'scroll', 'mousemove'].forEach(ev => {
      document.addEventListener(ev, () => {
        if (examIsActive && monitoringActive && penaltyEnabled) {
          awaySince = null;
        }
      });
    });

    // 1) Cambio de visibilidad (pesta√±as)
    document.addEventListener('visibilitychange', () => {
      if (currentStep !== 3) return;
      if (document.hidden) {
        markAway();
      } else {
        markBack('pesta√±a');
      }
    });

    // 2) Cambio de foco de ventana (Alt+Tab, otra ventana, carpetas, etc.)
    window.addEventListener('blur', () => {
      if (currentStep !== 3) return;
      markAway();
    });

    window.addEventListener('focus', () => {
      if (currentStep !== 3) return;
      markBack('ventana');
    });

    // Aviso si intenta cerrar o recargar mientras el examen est√° activo
    window.addEventListener('beforeunload', (event) => {
      if (examIsActive && !examCanceled) {
        event.preventDefault();
        event.returnValue = '';
      }
    });

    // Botones de pasos
    btnStep1Next.addEventListener('click', () => {
      goToStep(2);
    });

    btnStep2Next.addEventListener('click', () => {
      // Aqu√≠ confiamos en que el alumno ya envi√≥ el Forms de registro
      goToStep(3);
    });

    btnFinishExam.addEventListener('click', () => {
      // Pausamos completamente el sistema de penalizaciones mientras decide
      examIsActive = false;
      monitoringActive = false;
      penaltyEnabled = false;
      awaySince = null;
      suppressionUntil = 0;

      // Mostramos el cuadro de confirmaci√≥n
      finishOverlay.classList.remove('hidden');
    });

    // L√≥gica de confirmaci√≥n final
    btnConfirmYes.addEventListener('click', () => {
      // Ocultamos overlay y vamos a la p√°gina final
      finishOverlay.classList.add('hidden');
      goToStep(4);
    });

    btnConfirmNo.addEventListener('click', () => {
      // Ocultamos overlay
      finishOverlay.classList.add('hidden');

      // Si el examen ya fue cancelado, NO se puede regresar
      if (examCanceled) {
        goToStep(5);
        return;
      }

      // Reactivamos el examen y las penalizaciones, con una peque√±a supresi√≥n
      examIsActive = true;
      examCanceled = false;
      monitoringActive = true;
      penaltyEnabled = true;
      awaySince = null;
      suppressionUntil = Date.now() + 1500; // 1.5 s de colch√≥n

      // Aseguramos que visualmente siga en el Paso 3
      currentStep = 3;
      step1.classList.add('hidden');
      step2.classList.add('hidden');
      step3.classList.remove('hidden');
      step4.classList.add('hidden');
      step5.classList.add('hidden');
      examFrame.classList.remove('hidden');
      examStatusP.classList.remove('hidden');

      showMessage(
        '<strong>Contin√∫a con tu examen.</strong> Aseg√∫rate de enviar el formulario de Google Forms ' +
        'antes de volver a presionar "Finalizar examen".',
        'info'
      );
    });

    // Iniciar en el Paso 1
    goToStep(1);
  </script>
</body>
</html>
